{% extends "base.html" %}
{% block title %}Deposit Crypto{% endblock %}

{% block content %}
<div class="container">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow-sm">
        <div class="card-header">
          <h4 class="mb-0">Deposit Cryptocurrency</h4>
        </div>
        <div class="card-body">
          <form id="depositForm" method="POST" action="{{ url_for('wallet.deposit_crypto') }}">
            <div class="mb-3">
              <label for="coinDropdown" class="form-label">Select Cryptocurrency</label>
              <div class="dropdown">
                <button class="btn btn-light dropdown-toggle w-100 text-start" type="button" id="coinDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false">
                  <img id="selectedCoinIcon" src="https://coin-images.coingecko.com/coins/images/4128/thumb/solana.png?1718769756" alt="Icon" style="width: 20px; height: 20px; margin-right: 8px;">
                  <span id="selectedCoinText">{{ crypto_assets[0].name }} ({{ crypto_assets[0].symbol }})</span>
                </button>
                <ul class="dropdown-menu w-100" aria-labelledby="coinDropdownBtn" style="max-height: 300px; overflow-y: auto;">
                  {% for asset in crypto_assets %}
                    <li>
                      <a class="dropdown-item d-flex align-items-center coin-option" 
                         href="#" 
                         data-id="{{ asset.id }}"
                         data-symbol="{{ asset.symbol }}"
                         data-icon="https://coin-images.coingecko.com/coins/images/4128/thumb/solana.png?1718769756"
                         data-name="{{ asset.name }}">
                         
                        <img src="https://coin-images.coingecko.com/coins/images/4128/thumb/solana.png?1718769756" 
                             alt="{{ asset.symbol }} icon"
                             style="width: 20px; height: 20px; margin-right: 8px;">
                             
                        {{ asset.name }} ({{ asset.symbol }})
                      </a>
                    </li>
                  {% endfor %}
                </ul>
                <input type="hidden" id="coinSelect" name="coin" value="{{ crypto_assets[0].symbol }}">
              </div>
            </div>

            <div class="mb-3">
              <label for="networkSelect" class="form-label">Select Network</label>
              <select class="form-select" id="networkSelect" name="network" required>
                <option value="">Select a network</option>
                <option value="BITCOIN">Bitcoin</option>
                <option value="ETHEREUM">Ethereum</option>
                <option value="BSC">Binance Smart Chain</option>
                <option value="POLYGON">Polygon</option>
                <option value="TRON">TRON</option>
              </select>
            </div>

            <div class="mb-3">
              <label for="amount" class="form-label">Amount</label>
              <div class="input-group">
                <input 
                  type="number" 
                  class="form-control" 
                  id="amount" 
                  name="amount" 
                  step="0.00000001" 
                  min="0" 
                  required
                >
                <span class="input-group-text" id="assetSymbol">-</span>
              </div>
              <div class="form-text">Minimum deposit: 0.0001 BTC or equivalent</div>
            </div>

            <div class="d-grid gap-2 mb-3">
              <button type="button" class="btn btn-success" id="getDepositDetails">Get Deposit Address</button>
            </div>

            <!-- Deposit Address and QR Code Section -->
            <div id="depositDetails" class="mb-3 d-none">
              <div class="card">
                <div class="card-body">
                  <h5 class="card-title">Deposit Address</h5>
                  <div class="row">
                    <div class="col-md-6 text-center">
                      <img id="qrCode" src="" alt="QR Code" class="img-fluid mb-3" style="max-width: 200px;">
                    </div>
                    <div class="col-md-6">
                      <div class="input-group mb-3">
                        <input type="text" class="form-control" id="depositAddress" readonly>
                        <button class="btn btn-outline-secondary" type="button" id="copyAddress">
                          <i class="bi bi-clipboard"></i>
                        </button>
                      </div>
                      <small class="text-muted">Scan the QR code or copy the address above to deposit your cryptocurrency.</small>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="d-grid gap-2 mb-3 d-none" id="submitDepositWrapper">
              <button type="submit" class="btn btn-primary">Submit Deposit</button>
            </div>

            <div class="mb-3">
              <label for="tx_hash" class="form-label">Transaction Hash (Optional)</label>
              <input 
                type="text" 
                class="form-control" 
                id="tx_hash" 
                name="tx_hash" 
                placeholder="Enter the blockchain transaction hash"
              >
              <div class="form-text">This helps us track your deposit faster</div>
            </div>

            <div class="alert alert-info">
              <h6 class="alert-heading">Important Notes:</h6>
              <ul class="mb-0">
                <li>Only send the selected cryptocurrency to the address provided</li>
                <li>Double-check the amount and address before sending</li>
                <li>Deposits may take 1-3 network confirmations to appear in your account</li>
              </ul>
            </div>

            <div class="d-grid gap-2">
              <button type="button" class="btn btn-outline-secondary" onclick="history.back()">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Recent Deposits Table -->
<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-10">
      <div class="card shadow-sm">
        <div class="card-header">
          <h5 class="mb-0">Recent Deposits</h5>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-striped mb-0">
              <thead>
                <tr>
                  <th>Coin</th>
                  <th>Network</th>
                  <th>Amount</th>
                  <th>Txid</th>
                  <th>Status</th>
                  <th>Date & Time</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% if recent_deposits and recent_deposits|length > 0 %}
                  {% for tx in recent_deposits %}
                  <tr>
                    <td>{{ tx.asset.symbol }}</td>
                    <td>{{ tx.asset.deposit_addresses[0].network.value if tx.asset.deposit_addresses and tx.asset.deposit_addresses[0].network else '-' }}</td>
                    <td>{{ '%.8f'|format(tx.amount) }}</td>
                    <td>
                      {% if tx.external_tx_id %}
                        <span style="font-size: 0.9em;">{{ tx.external_tx_id[:6] }}...{{ tx.external_tx_id[-6:] }}</span>
                      {% else %}-{% endif %}
                    </td>
                    <td><span class="text-success">Completed</span></td>
                    <td>{{ tx.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                    <td><a href="#" class="btn btn-link btn-sm">Details</a></td>
                  </tr>
                  {% endfor %}
                {% else %}
                  <tr><td colspan="7" class="text-center">No recent deposits found.</td></tr>
                {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('coinSelect').addEventListener('change', function() {
    const symbol = this.options[this.selectedIndex].text.split('(')[1].split(')')[0];
    document.getElementById('assetSymbol').textContent = symbol;
  });

  // Add custom styling for select options with icons
  const style = document.createElement('style');
  style.textContent = `
    .form-select option {
      padding-left: 30px;
      background-repeat: no-repeat;
      background-position: 5px center;
      background-size: 20px;
    }
  `;
  document.head.appendChild(style);

  // Set background images for options
  const select = document.getElementById('coinSelect');
  Array.from(select.options).forEach(option => {
    if (option.dataset.icon) {
      option.style.backgroundImage = `url(${option.dataset.icon})`;
    }
  });

  // Handle Get Deposit Address button
  document.getElementById('getDepositDetails').addEventListener('click', function() {
    const assetSelect = document.getElementById('coinSelect');
    const networkSelect = document.getElementById('networkSelect');
    const amountInput = document.getElementById('amount');
    const depositDetails = document.getElementById('depositDetails');
    const submitDepositWrapper = document.getElementById('submitDepositWrapper');

    if (assetSelect.value && networkSelect.value && amountInput.value) {
      // Show deposit details section
      depositDetails.classList.remove('d-none');
      submitDepositWrapper.classList.remove('d-none');

      // Update QR code
      const qrCode = document.getElementById('qrCode');
      qrCode.src = `/wallet/deposit/crypto/qr/${assetSelect.value}/${networkSelect.value}`;

      // Fetch deposit address
      fetch(`/wallet/deposit/crypto/address/${assetSelect.value}/${networkSelect.value}`)
        .then(response => response.json())
        .then(data => {
          if (data.address) {
            document.getElementById('depositAddress').value = data.address;
          } else {
            document.getElementById('depositAddress').value = 'Error loading address';
          }
        })
        .catch(error => {
          console.error('Error fetching address:', error);
          document.getElementById('depositAddress').value = 'Error loading address';
        });
    } else {
      depositDetails.classList.add('d-none');
      submitDepositWrapper.classList.add('d-none');
      alert('Please select a coin, network, and enter an amount.');
    }
  });

  // Copy address functionality
  document.getElementById('copyAddress').addEventListener('click', function() {
    const addressInput = document.getElementById('depositAddress');
    addressInput.select();
    document.execCommand('copy');
    
    // Show feedback
    const originalText = this.innerHTML;
    this.innerHTML = '<i class="bi bi-check"></i>';
    setTimeout(() => {
      this.innerHTML = originalText;
    }, 2000);
  });

  // Custom dropdown for coin selection
  document.querySelectorAll('.coin-option').forEach(function(item) {
    item.addEventListener('click', function(e) {
      e.preventDefault();
      const icon = this.dataset.icon;
      const symbol = this.dataset.symbol;
      const name = this.dataset.name;

      // Update selected display
      document.getElementById('selectedCoinIcon').src = icon;
      document.getElementById('selectedCoinText').textContent = `${name} (${symbol})`;
      document.getElementById('coinSelect').value = symbol;
      document.getElementById('assetSymbol').textContent = symbol;
    });
  });
});
</script>
{% endblock %} 