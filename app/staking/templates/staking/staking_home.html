{% extends "layouts/vertical.html" %}
{% block title %}Staking{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/css/pages/cards-advance.css')}}">
{% endblock %}

{% block content %}
<div class="container-xxl flex-grow-1 container-p-y">

    {# ------------------------------------------------------------------- #}
    {# FLASH MESSAGES – surfacing WTForms validation + success messages   #}
    {# ------------------------------------------------------------------- #}
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="row mb-3">
            <div class="col-md-8 col-lg-6 mx-auto">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'success' if category=='success' else 'danger' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
    {% endwith %}

    {# ------------------------------------------------------------------- #}
    {# SEARCH / FILTER CARD                                             #}
    {# ------------------------------------------------------------------- #}
    <div class="row mb-4">
        <div class="col-md-8 col-lg-6 mx-auto">
            <div class="card">
                <div class="card-body">
                    <form method="GET" class="d-flex gap-3 align-items-end">
                        <div class="flex-grow-1">
                            <label for="search" class="form-label">Search Assets</label>
                            <input type="text"
                                   id="search"
                                   name="search"
                                   class="form-control"
                                   placeholder="Search by symbol or name…"
                                   value="{{ search_query }}"
                                   autocomplete="off">
                        </div>
                        <div>
                            <label for="per_page" class="form-label">Per Page</label>
                            <select name="per_page" id="per_page" class="form-select" style="width: 80px;">
                                <option value="5"  {% if current_per_page == 5  %}selected{% endif %}>5</option>
                                <option value="10" {% if current_per_page == 10 %}selected{% endif %}>10</option>
                                <option value="25" {% if current_per_page == 25 %}selected{% endif %}>25</option>
                                <option value="50" {% if current_per_page == 50 %}selected{% endif %}>50</option>
                            </select>
                        </div>
                        <div>
                            <button type="submit" class="btn btn-primary">
                                <i class="icon-base ti tabler-search me-1"></i>Search
                            </button>
                        </div>
                        {% if search_query %}
                        <div>
                            <a href="{{ url_for('staking.staking_home') }}" class="btn btn-outline-secondary">
                                <i class="icon-base ti tabler-x me-1"></i>Clear
                            </a>
                        </div>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>
    </div>

    {% if search_query %}
    <div class="row mb-3">
        <div class="col-md-8 col-lg-6 mx-auto">
            <div class="alert alert-info">
                <i class="icon-base ti tabler-info-circle me-1"></i>
                Found {{ pagination.total }} result(s) for "{{ search_query }}"
            </div>
        </div>
    </div>
    {% endif %}

    {# ------------------------------------------------------------------- #}
    {#  ASSET LIST                                                       #}
    {# ------------------------------------------------------------------- #}
    <div class="row">
        <div class="col-md-8 col-lg-6 mx-auto">
            <div class="card">
                <div class="card-datatable table-responsive pt-0">
                    <table class="datatables-basic table">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Asset</th>
                                <th>APR</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for asset in assets %}
                            <tr>
                                <td></td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar flex-shrink-0 me-3">
                                            {% if asset.image %}
                                                <img src="{{ asset.image }}" alt="{{ asset.name }} logo" class="rounded-circle" style="width:32px;height:32px;">
                                            {% else %}
                                                <div class="avatar-initial rounded-circle bg-label-primary">
                                                    {{ asset.symbol[0] if asset.symbol else 'A' }}
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <h6 class="mb-0">{{ asset.symbol }}</h6>
                                            <small class="text-body">{{ asset.name }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td><span class="badge bg-label-success">4.5%</span></td>
                                <td>
                                    <button class="btn btn-primary btn-sm stake-btn"
                                            data-bs-toggle="modal"
                                            data-bs-target="#stakingModal"
                                            data-asset-id="{{ asset.id }}"
                                            data-asset-symbol="{{ asset.symbol }}"
                                            data-asset-name="{{ asset.name }}"
                                            data-asset-image="{{ asset.image }}">
                                        <i class="icon-base ti tabler-coins me-1"></i>Stake
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="icon-base ti tabler-search icon-lg d-block mx-auto mb-2"></i>
                                        {% if search_query %}
                                            No assets found matching "{{ search_query }}"
                                        {% else %}
                                            No assets available for staking
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                {# Pagination block kept unchanged – omitted for brevity #}
                {# …                                                             #}
            </div>
        </div>
    </div>

    {# =================================================================== #}
    {#  MODAL 1 – ENTER DETAILS (NO FORM SUBMIT)                           #}
    {# =================================================================== #}
    <div class="modal fade" id="stakingModal" tabindex="-1" aria-labelledby="stakingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="stakingModalLabel"><i class="icon-base ti tabler-coins me-2"></i>Stake Asset</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex align-items-center mb-4 p-3 bg-light rounded">
                        <div class="avatar flex-shrink-0 me-3">
                            <img src="" id="modal-asset-image" class="rounded-circle" style="width:48px;height:48px;" alt="">
                        </div>
                        <div>
                            <h6 class="mb-1" id="modal-asset-symbol">Loading…</h6>
                            <small class="text-muted" id="modal-asset-name">Loading…</small>
                        </div>
                        <div class="ms-auto"><span class="badge bg-label-success fs-6">APR: 4.5%</span></div>
                    </div>

                    {# Plain inputs – will be copied into WTForms fields in modal 2 #}
                    <div class="mb-3">
                        <label for="stakeAmount" class="form-label">Amount to Stake</label>
                        <div class="input-group">
                            <input type="number" id="stakeAmount" class="form-control" placeholder="0.00" step="0.00000001" min="0">
                            <span class="input-group-text" id="stake-currency-symbol">CUR</span>
                        </div>
                        <div class="form-text">Available Balance:
                            <span class="text-primary fw-medium">
                            <span id="balance-amount">0.00</span>
                            <span id="balance-currency">CUR</span>
                            </span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="stakingPeriod" class="form-label">Staking Period</label>
                        <select id="stakingPeriod" class="form-select">
                            <option value="">Select staking period</option>
                            <option value="flexible">Flexible (No lock period – 4.5% APR)</option>
                            <option value="30">30 Days (5.0% APR)</option>
                            <option value="60">60 Days (5.5% APR)</option>
                            <option value="90">90 Days (6.0% APR)</option>
                        </select>
                    </div>

                    <div class="alert alert-info mb-3" id="stakingSummary" style="display:none;">
                        <h6 class="alert-heading mb-2"><i class="icon-base ti tabler-info-circle me-1"></i>Staking Summary</h6>
                        <div class="row">
                            <div class="col-6"><small class="text-muted">Amount:</small><br><span class="fw-medium" id="summary-amount">0.00 CUR</span></div>
                            <div class="col-6"><small class="text-muted">Est. Annual Rewards:</small><br><span class="fw-medium text-success" id="summary-rewards">0.00 CUR</span></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="proceedToConfirm" class="btn btn-primary" data-bs-target="#stakingConfirmModal" data-bs-toggle="modal" data-bs-dismiss="modal" disabled>
                        <i class="icon-base ti tabler-arrow-right me-1"></i>Review &amp; Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

    {# =================================================================== #}
    {#  MODAL 2 – CONFIRM + WTForms SUBMIT                                #}
    {# =================================================================== #}
    <div class="modal fade" id="stakingConfirmModal" tabindex="-1" aria-labelledby="stakingConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="confirmStakingForm" method="POST" action="{{ url_for('staking.stake_asset') }}">
                    {{ staking_form.csrf_token }}
                    {{ staking_form.asset_id(id='form-asset-id', type='hidden') }}
                    {{ staking_form.amount(id='form-amount', type='hidden') }}
                    <!-- Force the period field to be hidden -->
                    <input type="hidden" id="form-period" name="{{ staking_form.period.name }}" value="">


                    <div class="modal-header">
                        <h5 class="modal-title" id="stakingConfirmModalLabel"><i class="icon-base ti tabler-shield-check me-2"></i>Confirm Staking</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center mb-4">
                            <div class="avatar avatar-xl mx-auto mb-3"><img src="" id="confirm-asset-image" class="rounded-circle" alt=""></div>
                            <h6 class="mb-1">Confirm Staking Details</h6>
                            <small class="text-muted">Please review your staking information before confirming</small>
                        </div>

                        <div class="card border mb-3">
                            <div class="card-body">
                                <div class="row mb-3"><div class="col-4"><small class="text-muted">Asset:</small></div><div class="col-8"><span class="fw-medium" id="confirm-asset">CUR</span></div></div>
                                <div class="row mb-3"><div class="col-4"><small class="text-muted">Amount:</small></div><div class="col-8"><span class="fw-medium" id="confirm-amount">0.00 CUR</span></div></div>
                                <div class="row mb-3"><div class="col-4"><small class="text-muted">Period:</small></div><div class="col-8"><span class="fw-medium" id="confirm-period">–</span></div></div>
                                <div class="row mb-3"><div class="col-4"><small class="text-muted">APR:</small></div><div class="col-8"><span class="fw-medium text-success" id="confirm-apr">0%</span></div></div>
                                <hr>
                                <div class="row"><div class="col-4"><small class="text-muted">Est. Annual Rewards:</small></div><div class="col-8"><span class="fw-medium text-success" id="confirm-rewards">0.00 CUR</span></div></div>
                            </div>
                        </div>

                        <div class="form-check">
                            {{ staking_form.agree_terms(id='agreeTerms', class='form-check-input') }}
                            <label class="form-check-label" for="agreeTerms">I understand the staking terms and conditions</label>
                            {% for error in staking_form.agree_terms.errors %}<div class="invalid-feedback d-block">{{ error }}</div>{% endfor %}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-target="#stakingModal" data-bs-toggle="modal" data-bs-dismiss="modal"><i class="icon-base ti tabler-arrow-left me-1"></i>Back</button>
                        <button type="submit" id="confirmStaking" class="btn btn-success" disabled><i class="icon-base ti tabler-check me-1"></i>Confirm Staking</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/ui-modals.js') }}"></script>
<script src="{{ url_for('static', filename='js/cards-advance.js') }}"></script>
<script src="{{ url_for('static', filename='js/tables-datatables-basic.js') }}"></script>
<script>
// Debounced search and per‑page quick‑submit – unchanged
// Auto-submit form on per_page change
document.getElementById('per_page').addEventListener('change', function() {
    this.form.submit();
});

// Enhanced search with debouncing
let searchTimeout;
document.getElementById('search').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        // Auto-submit after 500ms of no typing
        if (this.value.length === 0 || this.value.length >= 2) {
            this.form.submit();
        }
    }, 500);
});
// … (existing code at top)

let currentStakingData = {};
const proceedBtn = document.getElementById('proceedToConfirm');
const stakeAmountInput = document.getElementById('stakeAmount');
const stakingPeriodSelect = document.getElementById('stakingPeriod');


//Start------------>
// Function to fetch and display asset balance
async function fetchAssetBalance(assetId, assetSymbol) {
  try {
    // Show loading state
    document.getElementById('balance-amount').textContent = 'Loading...';
    document.getElementById('balance-currency').textContent = '';
    
    const response = await fetch(`/staking/api/balance/${assetId}`);
    const data = await response.json();
    
    if (data.success) {
      // Update balance display
      document.getElementById('balance-amount').textContent = parseFloat(data.balance).toFixed(8);
      document.getElementById('balance-currency').textContent = data.asset_symbol;
      
      // Store balance for validation
      currentStakingData.balance = parseFloat(data.balance);
      currentStakingData.canStake = data.can_stake;
      
      // Update stake amount input max attribute
      stakeAmountInput.max = data.balance;
      
      // Add balance validation
      validateStakeAmount();
    } else {
      // Handle error
      document.getElementById('balance-amount').textContent = 'Error';
      document.getElementById('balance-currency').textContent = '';
      console.error('Failed to fetch balance:', data.error);
    }
  } catch (error) {
    document.getElementById('balance-amount').textContent = 'Error';
    document.getElementById('balance-currency').textContent = '';
    console.error('Error fetching balance:', error);
  }
}

// Function to validate stake amount against balance
function validateStakeAmount() {
  const amount = parseFloat(stakeAmountInput.value) || 0;
  const balanceError = document.getElementById('balance-error');
  
  // Remove existing error if it exists
  if (balanceError) {
    balanceError.remove();
  }
  
  // Check if amount exceeds balance
  if (amount > 0 && currentStakingData.balance !== undefined && amount > currentStakingData.balance) {
    // Add error message
    const errorDiv = document.createElement('div');
    errorDiv.id = 'balance-error';
    errorDiv.className = 'invalid-feedback d-block';
    errorDiv.textContent = 'Amount exceeds available balance';
    stakeAmountInput.parentNode.appendChild(errorDiv);
    stakeAmountInput.classList.add('is-invalid');
    return false;
  } else {
    stakeAmountInput.classList.remove('is-invalid');
    return true;
  }
}

// Add "Use Max" button functionality
function addUseMaxButton() {
  const balanceDiv = document.querySelector('.form-text');
  
  // Remove existing max button if present
  const existingMaxBtn = document.getElementById('use-max-btn');
  if (existingMaxBtn) {
    existingMaxBtn.remove();
  }
  
  // Add "Use Max" button
  const maxButton = document.createElement('button');
  maxButton.id = 'use-max-btn';
  maxButton.type = 'button';
  maxButton.className = 'btn btn-link btn-sm p-0 ms-2';
  maxButton.style.fontSize = '0.75rem';
  maxButton.textContent = 'Use Max';
  maxButton.onclick = () => {
    if (currentStakingData.balance !== undefined) {
      stakeAmountInput.value = currentStakingData.balance.toFixed(8);
      updateStakingSummary();
    }
  };
  
  balanceDiv.appendChild(maxButton);
}


//End-------------->

// Attach click handler to each stake button → open modal 1
// Update your existing stake button click handler
[...document.querySelectorAll('.stake-btn')].forEach(btn => {
  btn.addEventListener('click', async () => {
    currentStakingData = {
      id: btn.dataset.assetId,
      symbol: btn.dataset.assetSymbol,
      name: btn.dataset.assetName,
      image: btn.dataset.assetImage
    };

    // Populate modal 1 static bits
    document.getElementById('modal-asset-symbol').textContent = currentStakingData.symbol;
    document.getElementById('modal-asset-name').textContent = currentStakingData.name;
    document.getElementById('stake-currency-symbol').textContent = currentStakingData.symbol;
    document.getElementById('balance-currency').textContent = currentStakingData.symbol;
    
    if (currentStakingData.image) {
      document.getElementById('modal-asset-image').src = currentStakingData.image;
      document.getElementById('modal-asset-image').alt = `${currentStakingData.name} logo`;
    }

    // Reset inputs / summary
    stakeAmountInput.value = '';
    stakingPeriodSelect.value = '';
    document.getElementById('stakingSummary').style.display = 'none';
    proceedBtn.disabled = true;
    
    // Remove any existing validation errors
    stakeAmountInput.classList.remove('is-invalid');
    const existingError = document.getElementById('balance-error');
    if (existingError) {
      existingError.remove();
    }
    
    // Fetch the actual balance for this asset
    await fetchAssetBalance(currentStakingData.id, currentStakingData.symbol);
    
    // Add "Use Max" button
    addUseMaxButton();
  });
});

// Update your existing updateStakingSummary function to include validation
function updateStakingSummary() {
  const amount = parseFloat(stakeAmountInput.value) || 0;
  const period = stakingPeriodSelect.value;
  
  // Validate amount against balance
  const isValidAmount = validateStakeAmount();
  
  if (amount > 0 && period && isValidAmount) {
    const aprMap = { 'flexible': 4.5, '30': 5.0, '60': 5.5, '90': 6.0 };
    const apr = aprMap[period];
    const rewards = (amount * apr) / 100;
    
    document.getElementById('summary-amount').textContent = `${amount.toFixed(8)} ${currentStakingData.symbol}`;
    document.getElementById('summary-rewards').textContent = `${rewards.toFixed(8)} ${currentStakingData.symbol}`;
    document.getElementById('stakingSummary').style.display = 'block';
    proceedBtn.disabled = false;
  } else {
    document.getElementById('stakingSummary').style.display = 'none';
    proceedBtn.disabled = true;
  }
}
stakeAmountInput.addEventListener('input', updateStakingSummary);
stakingPeriodSelect.addEventListener('change', updateStakingSummary);

// When user proceeds → populate hidden WTForms inputs + confirmation UI
proceedBtn.addEventListener('click', () => {
  const amount = parseFloat(stakeAmountInput.value);
  const period = stakingPeriodSelect.value;
  const aprMap = { 'flexible': 4.5, '30': 5.0, '60': 5.5, '90': 6.0 };
  const apr = aprMap[period];
  const rewards = (amount * apr) / 100;

  // hidden form inputs (modal 2)
  document.getElementById('form-asset-id').value = currentStakingData.id;
  document.getElementById('form-amount').value   = amount.toFixed(8);
  document.getElementById('form-period').value   = period;

  // confirmation UI
  if (currentStakingData.image) document.getElementById('confirm-asset-image').src = currentStakingData.image;
  document.getElementById('confirm-asset').textContent   = `${currentStakingData.name} (${currentStakingData.symbol})`;
  document.getElementById('confirm-amount').textContent  = `${amount.toFixed(8)} ${currentStakingData.symbol}`;
  document.getElementById('confirm-period').textContent  = period === 'flexible' ? 'Flexible' : `${period} Days`;
  document.getElementById('confirm-apr').textContent     = `${apr}%`;
  document.getElementById('confirm-rewards').textContent = `${rewards.toFixed(8)} ${currentStakingData.symbol}`;

  // reset agree‑checkbox / submit‑button state
  document.getElementById('agreeTerms').checked = false;
  document.getElementById('confirmStaking').disabled = true;
});

// Enable submit only if terms are ticked
const agreeTerms = document.getElementById('agreeTerms');
agreeTerms.addEventListener('change', () => {
  document.getElementById('confirmStaking').disabled = !agreeTerms.checked;
});
</script>
{% endblock %}
