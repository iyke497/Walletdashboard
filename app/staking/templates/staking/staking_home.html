{% extends "layouts/vertical.html" %}
{% block title %}Staking{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/css/pages/cards-advance.css')}}">
{% endblock %}

{% block content %}
<div class="container-xxl flex-grow-1 container-p-y">
    <!-- Search and Filter Section -->
    <div class="row mb-4">
        <div class="col-md-8 col-lg-6 mx-auto">
            <div class="card">
                <div class="card-body">
                    <form method="GET" class="d-flex gap-3 align-items-end">
                        <div class="flex-grow-1">
                            <label for="search" class="form-label">Search Assets</label>
                            <input type="text" 
                                   id="search" 
                                   name="search" 
                                   class="form-control" 
                                   placeholder="Search by symbol or name..." 
                                   value="{{ search_query }}"
                                   autocomplete="off">
                        </div>
                        <div>
                            <label for="per_page" class="form-label">Per Page</label>
                            <select name="per_page" id="per_page" class="form-select" style="width: 80px;">
                                <option value="5" {% if current_per_page == 5 %}selected{% endif %}>5</option>
                                <option value="10" {% if current_per_page == 10 %}selected{% endif %}>10</option>
                                <option value="25" {% if current_per_page == 25 %}selected{% endif %}>25</option>
                                <option value="50" {% if current_per_page == 50 %}selected{% endif %}>50</option>
                            </select>
                        </div>
                        <div>
                            <button type="submit" class="btn btn-primary">
                                <i class="icon-base ti tabler-search me-1"></i>Search
                            </button>
                        </div>
                        {% if search_query %}
                        <div>
                            <a href="{{ url_for('staking.staking_home') }}" class="btn btn-outline-secondary">
                                <i class="icon-base ti tabler-x me-1"></i>Clear
                            </a>
                        </div>
                        {% endif %}
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Summary -->
    {% if search_query %}
    <div class="row mb-3">
        <div class="col-md-8 col-lg-6 mx-auto">
            <div class="alert alert-info">
                <i class="icon-base ti tabler-info-circle me-1"></i>
                Found {{ pagination.total }} result(s) for "{{ search_query }}"
            </div>
        </div>
    </div>
    {% endif %}

    <!-- DataTable with Buttons -->
    <div class="row">
        <div class="col-md-8 col-lg-6 mx-auto">
            <div class="card">
                <div class="card-datatable table-responsive pt-0">
                    <table class="datatables-basic table">
                        <thead>
                            <tr>
                                <th></th>
                                <th>Asset</th>
                                <th>APR</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for asset in assets %}
                            <tr>
                                <td></td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar flex-shrink-0 me-3">
                                            {% if asset.image %}
                                                <img src="{{ asset.image }}" 
                                                     alt="{{ asset.name }} logo" 
                                                     class="rounded-circle"
                                                     style="width: 32px; height: 32px;">
                                            {% else %}
                                                <div class="avatar-initial rounded-circle bg-label-primary">
                                                    {{ asset.symbol[0] if asset.symbol else 'A' }}
                                                </div>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <h6 class="mb-0">{{ asset.symbol }}</h6>
                                            <small class="text-body">{{ asset.name }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-label-success">4.5%</span>
                                </td>
                                <td>
                                    <button class="btn btn-primary btn-sm stake-btn" 
                                            data-bs-toggle="modal"
                                            data-bs-target="#stakingModal"
                                            data-asset-id="{{ asset.id }}"
                                            data-asset-symbol="{{ asset.symbol }}"
                                            data-asset-name="{{ asset.name }}"
                                            data-asset-image="{{ asset.image }}">
                                        <i class="icon-base ti tabler-coins me-1"></i>Stake
                                    </button>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="4" class="text-center py-4">
                                    <div class="text-muted">
                                        <i class="icon-base ti tabler-search icon-lg d-block mx-auto mb-2"></i>
                                        {% if search_query %}
                                            No assets found matching "{{ search_query }}"
                                        {% else %}
                                            No assets available for staking
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                {% if pagination.pages > 1 %}
                <div class="card-footer d-flex justify-content-between align-items-center">
                    <div class="text-muted small">
                        Showing {{ ((pagination.page - 1) * pagination.per_page) + 1 }} to 
                        {{ pagination.page * pagination.per_page if pagination.page * pagination.per_page < pagination.total else pagination.total }} 
                        of {{ pagination.total }} entries
                    </div>
                    
                    <nav aria-label="Page navigation">
                        <ul class="pagination pagination-sm mb-0">
                            <!-- Previous button -->
                            <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                                {% if pagination.has_prev %}
                                    <a class="page-link" href="{{ url_for('staking.staking_home', page=pagination.prev_num, per_page=current_per_page, search=search_query) }}">
                                        <i class="icon-base ti tabler-chevron-left"></i>
                                    </a>
                                {% else %}
                                    <span class="page-link">
                                        <i class="icon-base ti tabler-chevron-left"></i>
                                    </span>
                                {% endif %}
                            </li>

                            <!-- Page numbers -->
                            {% for page_num in pagination.iter_pages %}
                                {% if page_num %}
                                    {% if page_num != pagination.page %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('staking.staking_home', page=page_num, per_page=current_per_page, search=search_query) }}">
                                                {{ page_num }}
                                            </a>
                                        </li>
                                    {% else %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ page_num }}</span>
                                        </li>
                                    {% endif %}
                                {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link">â€¦</span>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            <!-- Next button -->
                            <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                                {% if pagination.has_next %}
                                    <a class="page-link" href="{{ url_for('staking.staking_home', page=pagination.next_num, per_page=current_per_page, search=search_query) }}">
                                        <i class="icon-base ti tabler-chevron-right"></i>
                                    </a>
                                {% else %}
                                    <span class="page-link">
                                        <i class="icon-base ti tabler-chevron-right"></i>
                                    </span>
                                {% endif %}
                            </li>
                        </ul>
                    </nav>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Staking Modal 1 - Asset Selection & Amount -->
    <div class="modal fade" id="stakingModal" aria-labelledby="stakingModalLabel" tabindex="-1" style="display: none" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="stakingModalLabel">
                        <i class="icon-base ti tabler-coins me-2"></i>Stake Asset
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Asset Info Display -->
                    <div class="d-flex align-items-center mb-4 p-3 bg-light rounded">
                        <div class="avatar flex-shrink-0 me-3" id="modal-asset-avatar">
                            <img src="" alt="" class="rounded-circle" style="width: 48px; height: 48px;" id="modal-asset-image">
                        </div>
                        <div>
                            <h6 class="mb-1" id="modal-asset-symbol">BTC</h6>
                            <small class="text-muted" id="modal-asset-name">Bitcoin</small>
                        </div>
                        <div class="ms-auto">
                            <span class="badge bg-label-success fs-6">APR: 4.5%</span>
                        </div>
                    </div>

                    <!-- Staking Form -->
                    <form id="stakingForm">
                        <div class="mb-3">
                            <label for="stakeAmount" class="form-label">Amount to Stake</label>
                            <div class="input-group">
                                <input type="number" 
                                       class="form-control" 
                                       id="stakeAmount" 
                                       placeholder="0.00" 
                                       step="0.00000001"
                                       min="0"
                                       required>
                                <span class="input-group-text" id="stake-currency-symbol">BTC</span>
                            </div>
                            <div class="form-text">
                                Available Balance: <span class="text-primary fw-medium">0.00 <span id="balance-currency">BTC</span></span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="stakingPeriod" class="form-label">Staking Period</label>
                            <select class="form-select" id="stakingPeriod" required>
                                <option value="">Select staking period</option>
                                <option value="flexible">Flexible (No lock period)</option>
                                <option value="30">30 Days (5.0% APR)</option>
                                <option value="60">60 Days (5.5% APR)</option>
                                <option value="90">90 Days (6.0% APR)</option>
                            </select>
                        </div>

                        <!-- Staking Summary -->
                        <div class="alert alert-info mb-3" id="stakingSummary" style="display: none;">
                            <h6 class="alert-heading mb-2">
                                <i class="icon-base ti tabler-info-circle me-1"></i>Staking Summary
                            </h6>
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">Amount:</small><br>
                                    <span class="fw-medium" id="summary-amount">0.00 BTC</span>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Est. Annual Rewards:</small><br>
                                    <span class="fw-medium text-success" id="summary-rewards">0.00 BTC</span>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" 
                            class="btn btn-primary" 
                            id="proceedToConfirm"
                            data-bs-target="#stakingConfirmModal" 
                            data-bs-toggle="modal" 
                            data-bs-dismiss="modal"
                            disabled>
                        <i class="icon-base ti tabler-arrow-right me-1"></i>Review & Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Staking Modal 2 - Confirmation -->
    <div class="modal fade" id="stakingConfirmModal" aria-hidden="true" aria-labelledby="stakingConfirmModalLabel" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="stakingConfirmModalLabel">
                        <i class="icon-base ti tabler-shield-check me-2"></i>Confirm Staking
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <div class="avatar avatar-xl mx-auto mb-3">
                            <img src="" alt="" class="rounded-circle" id="confirm-asset-image">
                        </div>
                        <h6 class="mb-1">Confirm Staking Details</h6>
                        <small class="text-muted">Please review your staking information before confirming</small>
                    </div>

                    <!-- Confirmation Details -->
                    <div class="card border">
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-4">
                                    <small class="text-muted">Asset:</small>
                                </div>
                                <div class="col-8">
                                    <span class="fw-medium" id="confirm-asset">BTC</span>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-4">
                                    <small class="text-muted">Amount:</small>
                                </div>
                                <div class="col-8">
                                    <span class="fw-medium" id="confirm-amount">0.00 BTC</span>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-4">
                                    <small class="text-muted">Period:</small>
                                </div>
                                <div class="col-8">
                                    <span class="fw-medium" id="confirm-period">30 Days</span>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-4">
                                    <small class="text-muted">APR:</small>
                                </div>
                                <div class="col-8">
                                    <span class="fw-medium text-success" id="confirm-apr">5.0%</span>
                                </div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-4">
                                    <small class="text-muted">Est. Annual Rewards:</small>
                                </div>
                                <div class="col-8">
                                    <span class="fw-medium text-success" id="confirm-rewards">0.00 BTC</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Terms Agreement -->
                    <div class="form-check mt-4">
                        <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                        <label class="form-check-label" for="agreeTerms">
                            I understand the staking terms and conditions
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" 
                            class="btn btn-outline-secondary" 
                            data-bs-target="#stakingModal" 
                            data-bs-toggle="modal" 
                            data-bs-dismiss="modal">
                        <i class="icon-base ti tabler-arrow-left me-1"></i>Back
                    </button>
                    <button type="button" class="btn btn-success" id="confirmStaking" disabled>
                        <i class="icon-base ti tabler-check me-1"></i>Confirm Staking
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal to add new record (keeping your existing modal) -->
    <div class="offcanvas offcanvas-end" id="add-new-record">
        <div class="offcanvas-header border-bottom">
            <h5 class="offcanvas-title" id="exampleModalLabel">New Record</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body flex-grow-1">
            <form class="add-new-record pt-0 row g-2" id="form-add-new-record" onsubmit="return false">
                <!-- Your existing form content -->
                <div class="col-sm-12">
                    <button type="submit" class="btn btn-primary data-submit me-sm-4 me-1">Submit</button>
                    <button type="reset" class="btn btn-outline-secondary" data-bs-dismiss="offcanvas">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/ui-modals.js') }}"></script>
<script src="{{ url_for('static', filename='js/cards-advance.js')}}"></script>
<script src="{{ url_for('static', filename='js/tables-datatables-basic.js')}}"></script>
<script>
// Auto-submit form on per_page change
document.getElementById('per_page').addEventListener('change', function() {
    this.form.submit();
});

// Enhanced search with debouncing
let searchTimeout;
document.getElementById('search').addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        // Auto-submit after 500ms of no typing
        if (this.value.length === 0 || this.value.length >= 2) {
            this.form.submit();
        }
    }, 500);
});

// Staking Modal Functionality
let currentStakingData = {};

// Handle stake button clicks
document.querySelectorAll('.stake-btn').forEach(button => {
    button.addEventListener('click', function() {
        const assetId = this.dataset.assetId;
        const assetSymbol = this.dataset.assetSymbol;
        const assetName = this.dataset.assetName;
        const assetImage = this.dataset.assetImage;
        
        // Store current staking data
        currentStakingData = {
            id: assetId,
            symbol: assetSymbol,
            name: assetName,
            image: assetImage
        };
        
        // Update modal content
        document.getElementById('modal-asset-symbol').textContent = assetSymbol;
        document.getElementById('modal-asset-name').textContent = assetName;
        document.getElementById('stake-currency-symbol').textContent = assetSymbol;
        document.getElementById('balance-currency').textContent = assetSymbol;
        
        if (assetImage) {
            document.getElementById('modal-asset-image').src = assetImage;
            document.getElementById('modal-asset-image').alt = `${assetName} logo`;
        }
        
        // Reset form
        document.getElementById('stakingForm').reset();
        document.getElementById('stakingSummary').style.display = 'none';
        document.getElementById('proceedToConfirm').disabled = true;
    });
});

// Handle form input changes
const stakeAmountInput = document.getElementById('stakeAmount');
const stakingPeriodSelect = document.getElementById('stakingPeriod');

function updateStakingSummary() {
    const amount = parseFloat(stakeAmountInput.value) || 0;
    const period = stakingPeriodSelect.value;
    
    if (amount > 0 && period) {
        const aprRates = {
            'flexible': 4.5,
            '30': 5.0,
            '60': 5.5,
            '90': 6.0
        };
        
        const apr = aprRates[period] || 4.5;
        const annualRewards = (amount * apr) / 100;
        
        // Update summary
        document.getElementById('summary-amount').textContent = `${amount.toFixed(8)} ${currentStakingData.symbol}`;
        document.getElementById('summary-rewards').textContent = `${annualRewards.toFixed(8)} ${currentStakingData.symbol}`;
        
        document.getElementById('stakingSummary').style.display = 'block';
        document.getElementById('proceedToConfirm').disabled = false;
    } else {
        document.getElementById('stakingSummary').style.display = 'none';
        document.getElementById('proceedToConfirm').disabled = true;
    }
}

stakeAmountInput.addEventListener('input', updateStakingSummary);
stakingPeriodSelect.addEventListener('change', updateStakingSummary);

// Handle proceed to confirm
document.getElementById('proceedToConfirm').addEventListener('click', function() {
    const amount = parseFloat(stakeAmountInput.value);
    const period = stakingPeriodSelect.value;
    const periodText = stakingPeriodSelect.options[stakingPeriodSelect.selectedIndex].text;
    
    const aprRates = {
        'flexible': 4.5,
        '30': 5.0,
        '60': 5.5,
        '90': 6.0
    };
    
    const apr = aprRates[period];
    const annualRewards = (amount * apr) / 100;
    
    // Update confirmation modal
    document.getElementById('confirm-asset-image').src = currentStakingData.image || '';
    document.getElementById('confirm-asset').textContent = `${currentStakingData.name} (${currentStakingData.symbol})`;
    document.getElementById('confirm-amount').textContent = `${amount.toFixed(8)} ${currentStakingData.symbol}`;
    document.getElementById('confirm-period').textContent = periodText;
    document.getElementById('confirm-apr').textContent = `${apr}%`;
    document.getElementById('confirm-rewards').textContent = `${annualRewards.toFixed(8)} ${currentStakingData.symbol}`;
    
    // Reset confirmation checkbox
    document.getElementById('agreeTerms').checked = false;
    document.getElementById('confirmStaking').disabled = true;
});

// Handle terms agreement checkbox
document.getElementById('agreeTerms').addEventListener('change', function() {
    document.getElementById('confirmStaking').disabled = !this.checked;
});

// Handle final staking confirmation
document.getElementById('confirmStaking').addEventListener('click', function() {
    // Show loading state
    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Processing...';
    this.disabled = true;
    
    // Simulate API call
    setTimeout(() => {
        // Reset button
        this.innerHTML = '<i class="icon-base ti tabler-check me-1"></i>Confirm Staking';
        this.disabled = false;
        
        // Close modal and show success message
        const modal = bootstrap.Modal.getInstance(document.getElementById('stakingConfirmModal'));
        modal.hide();
        
        // You would typically make an API call here
        alert(`Successfully staked ${document.getElementById('confirm-amount').textContent}!`);
        
        // Optionally reload the page or update the UI
    }, 2000);
});

// Reset modals when they're hidden
document.getElementById('stakingModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('stakingForm').reset();
    document.getElementById('stakingSummary').style.display = 'none';
    document.getElementById('proceedToConfirm').disabled = true;
});

document.getElementById('stakingConfirmModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('agreeTerms').checked = false;
    document.getElementById('confirmStaking').disabled = true;
});
</script>
{% endblock %}