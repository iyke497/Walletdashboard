{% extends "layouts/vertical.html" %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='vendor/css/pages/cards-advance.css')}}">
{% endblock %}



{% block content %}
<div class="container-xxl flex-grow-1 container-p-y">
    {# CARD WITH TABS for Mining pools and Positions #}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="nav-align-top">
                        <ul class="nav nav-pills mb-3" role="tablist">
                            <li class="nav-item">
                                <button type="button" class="nav-link active" role="tab" data-bs-toggle="tab"
                                        data-bs-target="#navs-pills-tab-mining-pools"
                                        aria-controls="navs-pills-tab-mining-pools" aria-selected="true">
                                    Mining Pools
                                </button>
                            </li>
                            <li class="nav-item">
                                <button type="button" class="nav-link" role="tab" data-bs-toggle="tab"
                                        data-bs-target="#navs-pills-tab-my-positions"
                                        aria-controls="navs-pills-tab-my-positions" aria-selected="false">
                                    Mining Contracts
                                </button>
                            </li>
                            {# Add other tabs here if needed, e.g., "Earnings History" #}
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div class="tab-content p-0">
                        {# ------------- TAB 1: MINING POOLS ------------- #}
                        <div class="tab-pane fade show active" id="navs-pills-tab-mining-pools" role="tabpanel">
                            {# SEARCH / FILTER CARD (existing code from your staking_home.html) #}
                            <div class="row mb-4">
                                <div class="col-md-12 col-lg-10 mx-auto">
                                    <div class="card shadow-sm">
                                        <div class="card-body">
                                            <form method="GET" action="{{ url_for('staking.mining_home') }}#navs-pills-tab-mining-pools" class="d-flex flex-wrap gap-3 align-items-end">
                                                {# Ensure form action includes hash to return to the correct tab #}
                                                <!--Searchbox-->
                                                <div class="flex-grow-1">
                                                    <label for="search" class="form-label">Search Pools</label>
                                                    <input type="text" id="search" name="search" class="form-control" placeholder="Search by symbol or name…" value="{{ search_query }}" autocomplete="off">
                                                </div>

                                                <!--Algorithm Dropdown-->
                                                <div>
                                                    <label for="algorithm" class="form-label">Algorithm</label>
                                                    <select name="algorithm" id="algorithm" class="form-select">
                                                        <option value="">All Algorithms</option>
                                                        {% for algo in algorithms %}
                                                            <option value="{{ algo.value }}" {% if algorithm_filter == algo.value %}selected{% endif %}>{{ algo.name }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>

                                                <!--Difficulty Dropdown-->
                                                <div>
                                                    <label for="difficulty" class="form-label">Difficulty</label>
                                                    <select name="difficulty" id="difficulty" class="form-select">
                                                        <option value="">Any Difficulty</option>
                                                        {% for diff in difficulties %}
                                                            <option value="{{ diff.value }}" {% if difficulty_filter == diff.value %}selected{% endif %}>{{ diff.name.title() }}</option>
                                                        {% endfor %}
                                                    </select>
                                                </div>

                                                <!--Pagination Selection-->
                                                <div style="min-width: 80px;">
                                                    <label for="per_page" class="form-label">Per Page</label>
                                                    <select name="per_page" id="per_page" class="form-select" style="width: auto;">
                                                        <option value="5"  {% if current_per_page == 5  %}selected{% endif %}>5</option>
                                                        <option value="10" {% if current_per_page == 10 %}selected{% endif %}>10</option>
                                                        <option value="25" {% if current_per_page == 25 %}selected{% endif %}>25</option>
                                                        <option value="50" {% if current_per_page == 50 %}selected{% endif %}>50</option>
                                                    </select>
                                                </div>
                                                <!--Search Button-->
                                                <div>
                                                    <button type="submit" class="btn btn-primary">
                                                        <i class="icon-base ti tabler-search me-1"></i>Search
                                                    </button>
                                                </div>
                                                {% if search_query %}
                                                <div>
                                                    <a href="{{ url_for('staking.mining_home') }}#navs-pills-tab-mining-pools" class="btn btn-outline-secondary">
                                                        <i class="icon-base ti tabler-x me-1"></i>Clear
                                                    </a>
                                                </div>
                                                {% endif %}
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {% if search_query %}
                            <div class="row mb-3">
                                <div class="col-md-10 col-lg-8 mx-auto">
                                    <div class="alert alert-info">
                                        <i class="icon-base ti tabler-info-circle me-1"></i>
                                        Found {{ pagination.total }} result(s) for "{{ search_query }}"
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            {# POOLS/ASSET LIST #}
                            <div class="row">
                                <div class="col-md-12 col-lg-10 mx-auto">
                                    <div class="card shadow-sm">
                                        <div class="card-datatable table-responsive pt-0">
                                            <table class="datatables-basic table">
                                                <thead>
                                                    <tr>
                                                        <th></th>
                                                        <th>Asset</th>
                                                        <th>Algorithm</th>
                                                        <th>Pool fee</th>
                                                        <th>Difficulty</th>
                                                        <th>Hashrate</th>
                                                        <th>Price</th>
                                                        <th>APR</th>
                                                        <th>Action</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for pool in pools %}
                                                    <tr>
                                                        <td></td>
                                                        <td>
                                                            <div class="d-flex align-items-center">
                                                                <div class="avatar flex-shrink-0 me-3">
                                                                    {% if pool.asset.images %}
                                                                    <img 
                                                                    src="{{ pool.asset.images.get('small', pool.asset.images.get('thumb', '')) }}" 
                                                                    alt="{{ pool.asset.name }} logo" 
                                                                    class="rounded-circle" 
                                                                    style="width:32px;height:32px;"
                                                                    >
                                                                    {% else %}
                                                                        <div class="avatar-initial rounded-circle bg-label-primary">
                                                                            {{ pool.asset.symbol[0] if pool.asset.symbol else 'A' }}
                                                                        </div>
                                                                    {% endif %}
                                                                </div>
                                                                <div>
                                                                    <h6 class="mb-0">{{ pool.asset.symbol }}</h6>
                                                                    <small class="text-body">{{ pool.name }}</small>
                                                                </div>
                                                            </div>
                                                        </td>
                                                        <td><span>{{ pool.algorithm.name }}</span></td>
                                                        <td>{{ "%.2f"|format(pool.pool_fee * 100) }}%</td>
                                                        <td>
                                                            {% if pool.difficulty.value == 'low' %}
                                                                <span class="badge bg-label-success">Low</span>
                                                            {% elif pool.difficulty.value == 'medium' %}
                                                                <span class="badge bg-label-warning">Medium</span>
                                                            {% elif pool.difficulty.value == 'high' %}
                                                                <span class="badge bg-label-danger">High</span>
                                                            {% elif pool.difficulty.value == 'very_high' %}
                                                                <span class="badge bg-label-danger">Very High</span>
                                                            {% else %}
                                                                <span class="badge bg-label-secondary">{{ pool.difficulty.name.title() }}</span>
                                                            {% endif %}
                                                        </td>
                                                        <td>{{ "%.2f"|format(pool.min_hashrate) }} {{ pool.min_hashrate_unit.value }}</td>
                                                        <td>${{ "%.4f"|format(pool.estimated_daily_earnings_per_unit) }} / ({{ pool.min_hashrate_unit.value }})</td>
                                                        <td><span class="badge bg-label-success">4.5%</span></td> {# This APR should be dynamic from asset data if available #}
                                                        <td>
                                                            <button class="btn btn-primary btn-sm mining-btn"
                                                                    data-bs-toggle="modal"
                                                                    data-bs-target="#miningModal"
                                                                    data-pool-id="{{ pool.id }}"
                                                                    data-asset-symbol="{{ pool.asset.symbol }}"
                                                                    data-asset-name="{{ pool.asset.name }}"
                                                                    data-asset-image="{{ pool.asset.images.get('small', pool.asset.images.get('thumb', '')) if pool.asset.images else '' }}"
                                                                    data-algorithm="{{ pool.algorithm.name }}"
                                                                    data-pool-fee="{{ '%.2f'|format(pool.pool_fee * 100) }}"
                                                                    data-min-hashrate="{{ pool.min_hashrate }}"
                                                                    data-hashrate-unit="{{ pool.min_hashrate_unit.value }}"
                                                                    data-earnings-per-unit="{{ pool.estimated_daily_earnings_per_unit }}"
                                                                    data-difficulty="{{ pool.difficulty.name.title() }}">
                                                                <i class="icon-base ti tabler-coins me-1"></i>Mine
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    {% else %}
                                                    <tr>
                                                        <td colspan="4" class="text-center py-4">
                                                            <div class="text-muted">
                                                                <i class="icon-base ti tabler-search icon-lg d-block mx-auto mb-2"></i>
                                                                {% if search_query %}
                                                                    No mining pools found matching "{{ search_query }}"
                                                                {% else %}
                                                                    No mining pools available at the moment.
                                                                {% endif %}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>

                                        {# PAGINATION (existing code - ensure links point to the correct tab with hash) #}
                                        {% if pagination and pagination.pages > 1 %}
                                        <div class="card-footer d-flex justify-content-center">
                                            <nav aria-label="Mining pools navigation">
                                                <ul class="pagination">
                                                    <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                                                        <a class="page-link" href="{{ url_for('staking.mining_home', page=pagination.prev_num, per_page=current_per_page, search=search_query) if pagination.has_prev else '#'}}#navs-pills-tab-stake-assets"><i class="ti ti-chevron-left"></i></a>
                                                    </li>
                                                    {% for p_num in pagination.iter_pages %}
                                                        {% if p_num %}
                                                            <li class="page-item {% if p_num == pagination.page %}active{% endif %}">
                                                                <a class="page-link" href="{{ url_for('staking.mining_home', page=p_num, per_page=current_per_page, search=search_query) }}#navs-pills-tab-stake-assets">{{ p_num }}</a>
                                                            </li>
                                                        {% else %}
                                                            <li class="page-item disabled"><span class="page-link">…</span></li>
                                                        {% endif %}
                                                    {% endfor %}
                                                    <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                                                        <a class="page-link" href="{{ url_for('staking.mining_home', page=pagination.next_num, per_page=current_per_page, search=search_query) if pagination.has_next else '#'}}#navs-pills-tab-stake-assets"><i class="ti ti-chevron-right"></i></a>
                                                    </li>
                                                </ul>
                                            </nav>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>{# /#navs-pills-tab-mining-pools #}

                        {# ------------- TAB 2: MY MINING CONTRACTS ------------- #}
                        <div class="tab-pane fade" id="navs-pills-tab-my-positions" role="tabpanel">
                            <h4 class="mb-3 pt-3">Your Active Mining Contracts</h4>
                            <p>Total Contracts: <span class="fw-bold">{{ total_mining_positions }}</span> | Currently Active: <span class="fw-bold text-success">{{ active_mining_positions }}</span></p>

                            {% if user_mining_positions %}
                            <div class="table-responsive text-nowrap">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Asset</th>
                                            <th>Contract Name</th>
                                            <th>Hashrate</th>
                                            <th>Duration</th>
                                            <th>Monthly Cost</th>
                                            <th>Start Date</th>
                                            <th>End Date</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody class="table-border-bottom-0">
                                        {% for contract in user_mining_positions %}
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    {% if contract.asset_image %}
                                                        <img src="{{ contract.asset_image }}" alt="{{ contract.asset_symbol }}" class="avatar avatar-xs rounded-circle me-2">
                                                    {% else %}
                                                        <div class="avatar avatar-xs avatar-initial rounded-circle bg-label-secondary me-2">{{ contract.asset_symbol[0] if contract.asset_symbol else '?' }}</div>
                                                    {% endif %}
                                                    <div>
                                                        <span class="fw-medium">{{ contract.asset_symbol }}</span><br>
                                                        <small class="text-muted">{{ contract.asset_name }}</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div>
                                                    <span class="fw-medium">{{ contract.name }}</span><br>
                                                    {% if contract.hardware_type %}
                                                        <small class="text-muted">{{ contract.hardware_type }}</small>
                                                    {% endif %}
                                                </div>
                                            </td>
                                            <td>
                                                <span class="fw-medium">{{ contract.hashrate }} {{ contract.hashrate_unit }}</span>
                                                {% if contract.power_consumption %}
                                                    <br><small class="text-muted">{{ contract.power_consumption }}W</small>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="fw-medium">{{ contract.duration_months }} Month{{ 's' if contract.duration_months > 1 else '' }}</span>
                                                {% if contract.end_date %}
                                                    <br><small class="text-muted">Until {{ contract.end_date.strftime('%Y-%m-%d') }}</small>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="fw-medium">${{ "%.2f"|format(contract.monthly_cost) }}</span>
                                                <br><small class="text-muted">Total: ${{ "%.2f"|format(contract.total_cost) }}</small>
                                            </td>
                                            <td>{{ contract.start_date.strftime('%Y-%m-%d %H:%M') if contract.start_date else contract.created_at.strftime('%Y-%m-%d %H:%M') if contract.created_at else 'N/A' }}</td>
                                            <td>{{ contract.end_date.strftime('%Y-%m-%d %H:%M') if contract.end_date else 'Ongoing' }}</td>
                                            <td>
                                                <span class="badge rounded-pill
                                                    {% if contract.status == 'pending' %} bg-label-warning
                                                    {% elif contract.status == 'active' %} bg-label-success
                                                    {% elif contract.status == 'paused' %} bg-label-secondary
                                                    {% elif contract.status == 'completed' %} bg-label-primary
                                                    {% elif contract.status == 'cancelled' %} bg-label-danger
                                                    {% else %} bg-label-secondary {% endif %}">
                                                    {{ contract.status|capitalize }}
                                                </span>
                                            </td>
                                            <td>
                                                {% if contract.status == 'active' %}
                                                    <div class="btn-group" role="group">
                                                        <button type="button" class="btn btn-warning btn-sm pause-contract-btn"
                                                                data-contract-id="{{ contract.id }}"
                                                                data-asset-symbol="{{ contract.asset_symbol }}"
                                                                title="Pause Contract">
                                                            <i class="ti ti-player-pause ti-xs tabler-player-pause"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-danger btn-sm cancel-contract-btn"
                                                                data-bs-toggle="modal"
                                                                data-bs-target="#cancelContractModal"
                                                                data-contract-id="{{ contract.id }}"
                                                                data-contract-name="{{ contract.name }}"
                                                                data-asset-symbol="{{ contract.asset_symbol }}"
                                                                title="Cancel Contract">
                                                            <i class="ti ti-x ti-xs tabler-circle-x"></i>
                                                        </button>
                                                    </div>
                                                {% elif contract.status == 'paused' %}
                                                    <div class="btn-group" role="group">
                                                        <button type="button" class="btn btn-success btn-sm resume-contract-btn"
                                                                data-contract-id="{{ contract.id }}"
                                                                data-asset-symbol="{{ contract.asset_symbol }}"
                                                                title="Resume Contract">
                                                            <i class="ti ti-player-play ti-xs"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-danger btn-sm cancel-contract-btn"
                                                                data-bs-toggle="modal"
                                                                data-bs-target="#cancelContractModal"
                                                                data-contract-id="{{ contract.id }}"
                                                                data-contract-name="{{ contract.name }}"
                                                                data-asset-symbol="{{ contract.asset_symbol }}"
                                                                title="Cancel Contract">
                                                            <i class="ti ti-x ti-xs"></i>
                                                        </button>
                                                    </div>
                                                {% elif contract.status == 'pending' %}
                                                    <button type="button" class="btn btn-danger btn-sm cancel-contract-btn"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#cancelContractModal"
                                                            data-contract-id="{{ contract.id }}"
                                                            data-contract-name="{{ contract.name }}"
                                                            data-asset-symbol="{{ contract.asset_symbol }}"
                                                            title="Cancel Contract">
                                                        <i class="ti ti-x me-1 ti-xs tabler-circle-x"></i>Cancel
                                                    </button>
                                                {% else %}
                                                    <span class="text-muted small fst-italic">-</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <i class="ti ti-pickaxe ti-lg mb-2 d-block mx-auto text-muted"></i>
                                <p class="text-muted">You have no mining contracts yet.</p>
                                <p><small>Explore mining pools in the "Mining Pools" tab to get started!</small></p>
                            </div>
                            {% endif %}
                        </div>{# /#navs-pills-tab-my-positions #}
                    </div>
                </div>{# /.card-body #}
            </div>{# /.card #}
        </div>{# /.col-12 #}
    </div>{# /.row #}

    {# MODAL 1 – ENTER DETAILS (NO FORM SUBMIT) #}
    <div class="modal fade" id="miningModal" tabindex="-1" aria-labelledby="miningModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-md" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="miningModalLabel"><i class="icon-base ti tabler-coins me-2"></i>Create Mining Contract</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <div class="asset-image mb-3">
                            <div class="avatar avatar-lg">
                                <img src="" alt="Asset logo" id="modalAssetImage" class="rounded-circle" style="width:64px;height:64px;object-fit:cover;display:none;">
                                <div class="avatar-initial rounded-circle bg-label-primary" id="modalAssetInitial">
                                    A
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <h4 id="modalAssetName">Bitcoin</h4>
                            <span id="modalAssetSymbol" class="badge bg-label-primary">BTC</span>
                            <span id="modalAlgorithm" class="badge bg-label-info ms-1">SHA-256</span>
                            <span id="modalPoolFee" class="badge bg-label-warning ms-1">1% Pool Fee</span>
                            <span id="modalDifficulty" class="badge bg-label-danger ms-1">Medium</span>
                        </div>
                        <div class="alert alert-info">
                            <div class="d-flex align-items-center">
                                <i class="icon-base ti tabler-info-circle me-2"></i>
                                <div>
                                    <div>Min. Hashrate: <span id="modalMinHashrate" class="fw-bold">0.1 TH/s</span></div>
                                    <div>Est. Daily Earnings: <span id="modalEarningsPerUnit" class="fw-bold">$0.05 per TH/s</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <label class="form-label">Hashrate Package</label>
                            <div class="package-selection-container">
                                <div class="form-check custom-option custom-option-basic mb-2">
                                    <label class="form-check-label custom-option-content p-2" for="package_selection_basic">
                                        <input name="package_selection" class="form-check-input" type="radio" value="basic" id="package_selection_basic">
                                        <span class="d-flex justify-content-between">
                                            <span>
                                                <span class="custom-option-header">
                                                    <span class="fw-semibold">Basic Package</span>
                                                </span>
                                                <span class="custom-option-body package-description" id="package_desc_basic">
                                                    <small>Loading...</small>
                                                </span>
                                            </span>
                                            <span class="text-end">
                                                <span class="custom-option-header">
                                                    <span class="fw-semibold package-price" id="package_price_basic">
                                                        $0.00/mo
                                                    </span>
                                                </span>
                                                <span class="custom-option-body">
                                                    <small class="package-power" id="package_power_basic">
                                                        0W
                                                    </small>
                                                </span>
                                            </span>
                                        </span>
                                    </label>
                                </div>
                                <div class="form-check custom-option custom-option-basic mb-2">
                                    <label class="form-check-label custom-option-content p-2" for="package_selection_pro">
                                        <input name="package_selection" class="form-check-input" type="radio" value="pro" id="package_selection_pro" checked>
                                        <span class="d-flex justify-content-between">
                                            <span>
                                                <span class="custom-option-header">
                                                    <span class="fw-semibold">Pro Package</span>
                                                </span>
                                                <span class="custom-option-body package-description" id="package_desc_pro">
                                                    <small>Loading...</small>
                                                </span>
                                            </span>
                                            <span class="text-end">
                                                <span class="custom-option-header">
                                                    <span class="fw-semibold package-price" id="package_price_pro">
                                                        $0.00/mo
                                                    </span>
                                                </span>
                                                <span class="custom-option-body">
                                                    <small class="package-power" id="package_power_pro">
                                                        0W
                                                    </small>
                                                </span>
                                            </span>
                                        </span>
                                    </label>
                                </div>
                                <div class="form-check custom-option custom-option-basic mb-2">
                                    <label class="form-check-label custom-option-content p-2" for="package_selection_enterprise">
                                        <input name="package_selection" class="form-check-input" type="radio" value="enterprise" id="package_selection_enterprise">
                                        <span class="d-flex justify-content-between">
                                            <span>
                                                <span class="custom-option-header">
                                                    <span class="fw-semibold">Enterprise Package</span>
                                                </span>
                                                <span class="custom-option-body package-description" id="package_desc_enterprise">
                                                    <small>Loading...</small>
                                                </span>
                                            </span>
                                            <span class="text-end">
                                                <span class="custom-option-header">
                                                    <span class="fw-semibold package-price" id="package_price_enterprise">
                                                        $0.00/mo
                                                    </span>
                                                </span>
                                                <span class="custom-option-body">
                                                    <small class="package-power" id="package_power_enterprise">
                                                        0W
                                                    </small>
                                                </span>
                                            </span>
                                        </span>
                                    </label>
                                </div>
                                <div class="form-check custom-option custom-option-basic mb-2">
                                    <label class="form-check-label custom-option-content p-2" for="package_selection_custom">
                                        <input name="package_selection" class="form-check-input" type="radio" value="custom" id="package_selection_custom">
                                        <span class="d-flex justify-content-between">
                                            <span>
                                                <span class="custom-option-header">
                                                    <span class="fw-semibold">Custom Package</span>
                                                </span>
                                                <span class="custom-option-body package-description" id="package_desc_custom">
                                                    <small>Specify your own hashrate</small>
                                                </span>
                                            </span>
                                            <span class="text-end">
                                                <span class="custom-option-header">
                                                    <span class="fw-semibold package-price" id="package_price_custom">
                                                        <i class="ti ti-settings"></i>
                                                    </span>
                                                </span>
                                            </span>
                                        </span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {# Custom Hashrate Fields - shown only when custom package is selected #}
                    <div id="customHashrateFields" class="row g-3 mb-3" style="display:none;">
                        <div class="col-md-8">
                            <label for="custom_hashrate" class="form-label">Custom Hashrate</label>
                            <div class="input-group">
                                <input type="number" id="custom_hashrate" class="form-control" placeholder="Enter hashrate" step="0.1" min="0.1">
                                <select id="custom_hashrate_unit" class="form-select input-group-text custom-select-sm" style="max-width: 120px;">
                                    <option value="TH/s">TH/s</option>
                                    <option value="GH/s">GH/s</option>
                                    <option value="MH/s">MH/s</option>
                                </select>
                            </div>
                            <div class="form-text">Minimum hashrate: <span id="minHashrateText">0.1 TH/s</span></div>
                        </div>
                    </div>
                    
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="duration" class="form-label">Contract Duration</label>
                            <select id="duration" class="form-select">
                                <option value="1">1 Month</option>
                                <option value="3">3 Months (5% discount)</option>
                                <option value="6">6 Months (10% discount)</option>
                                <option value="12">12 Months (15% discount)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="contract_name" class="form-label">Contract Name (Optional)</label>
                            <input type="text" id="contract_name" class="form-control" placeholder="e.g., My BTC Miner #1">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-12">
                            <div class="alert alert-primary">
                                <div class="d-flex align-items-center">
                                    <i class="icon-base ti tabler-calculator me-2"></i>
                                    <div>
                                        <div>Monthly cost: <span id="monthlyCost" class="fw-bold">$0.00</span></div>
                                        <div>Est. monthly earnings: <span id="monthlyEarnings" class="fw-bold">$0.00</span></div>
                                        <div>Total contract cost: <span id="totalCost" class="fw-bold">$0.00</span></div>
                                        <div class="mt-1 text-success">Potential profit: <span id="potentialProfit" class="fw-bold">$0.00</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" id="proceedToConfirm" class="btn btn-primary" data-bs-target="#miningConfirmModal" data-bs-toggle="modal" data-bs-dismiss="modal">
                        <i class="icon-base ti tabler-arrow-right me-1"></i>Review &amp; Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

    {# MODAL 2 – CONFIRM + WTForms SUBMIT #}
    <div class="modal fade" id="miningConfirmModal" tabindex="-1" aria-labelledby="miningConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <form id="confirmMiningForm" method="POST" action="{{ url_for('staking.create_mining_contract') }}">
                    {{ contract_form.csrf_token }}
                    {{ contract_form.pool_id(id='form-pool-id', type='hidden') }}
                    {{ contract_form.package_id(id='form-package-id', type='hidden') }}
                    <input type="hidden" id="form-package-selection" name="{{ contract_form.package_selection.name }}" value="pro">
                    <input type="hidden" id="form-custom-hashrate" name="{{ contract_form.custom_hashrate.name }}" value="">
                    <input type="hidden" id="form-custom-hashrate-unit" name="{{ contract_form.custom_hashrate_unit.name }}" value="TH/s">
                    <input type="hidden" id="form-duration" name="{{ contract_form.duration.name }}" value="1">
                    <input type="hidden" id="form-contract-name" name="{{ contract_form.contract_name.name }}" value="">
                    
                    <div class="modal-header">
                        <h5 class="modal-title" id="miningConfirmModalLabel"><i class="icon-base ti tabler-shield-check me-2"></i>Confirm Mining Contract</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center mb-4">
                            <div class="avatar avatar-lg mb-3">
                                <img src="" alt="Asset logo" id="confirmAssetImage" class="rounded-circle" style="width:64px;height:64px;object-fit:cover;display:none;">
                                <div class="avatar-initial rounded-circle bg-label-primary" id="confirmAssetInitial">
                                    A
                                </div>
                            </div>
                            <h6 class="mb-1">Confirm Mining Contract Details</h6>
                            <small class="text-muted">Please review your mining contract information before confirming</small>
                        </div>

                        <div class="card border mb-3">
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-5"><small class="text-muted">Asset:</small></div>
                                    <div class="col-7"><span class="fw-medium" id="confirm-asset">BTC</span></div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-5"><small class="text-muted">Algorithm:</small></div>
                                    <div class="col-7"><span class="fw-medium" id="confirm-algorithm">SHA-256</span></div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-5"><small class="text-muted">Package:</small></div>
                                    <div class="col-7"><span class="fw-medium" id="confirm-package">Pro Package</span></div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-5"><small class="text-muted">Hashrate:</small></div>
                                    <div class="col-7"><span class="fw-medium" id="confirm-hashrate">1.0 TH/s</span></div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-5"><small class="text-muted">Duration:</small></div>
                                    <div class="col-7"><span class="fw-medium" id="confirm-duration">1 Month</span></div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-5"><small class="text-muted">Pool Fee:</small></div>
                                    <div class="col-7"><span class="fw-medium" id="confirm-fee">1.0%</span></div>
                                </div>
                                <hr>
                                <div class="row mb-3">
                                    <div class="col-5"><small class="text-muted">Monthly Cost:</small></div>
                                    <div class="col-7"><span class="fw-medium" id="confirm-monthly-cost">$50.00</span></div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-5"><small class="text-muted">Est. Monthly Earnings:</small></div>
                                    <div class="col-7"><span class="fw-medium text-success" id="confirm-monthly-earnings">$60.00</span></div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-5"><small class="text-muted">Total Contract Cost:</small></div>
                                    <div class="col-7"><span class="fw-medium" id="confirm-total-cost">$50.00</span></div>
                                </div>
                                <div class="row">
                                    <div class="col-5"><small class="text-muted">Potential Profit:</small></div>
                                    <div class="col-7"><span class="fw-medium text-success" id="confirm-profit">$10.00</span></div>
                                </div>
                            </div>
                        </div>

                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                            <label class="form-check-label" for="agreeTerms">
                                I understand the mining contract terms and conditions
                            </label>
                            <div class="invalid-feedback">
                                You must agree to the terms before proceeding
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-target="#miningModal" data-bs-toggle="modal" data-bs-dismiss="modal">
                            <i class="icon-base ti tabler-arrow-left me-1"></i>Back
                        </button>
                        <button type="submit" id="confirmMining" class="btn btn-success" disabled>
                            <i class="icon-base ti tabler-check me-1"></i>Confirm Contract
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {# MODAL: CANCEL CONTRACT CONFIRMATION #}
    <div class="modal fade" id="cancelContractModal" tabindex="-1" aria-labelledby="cancelContractModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="confirmCancelForm" method="POST" action="{{ url_for('staking.cancel_mining_contract') }}">
                    {{ csrf_token() }}
                    <input type="hidden" id="cancel-contract-id" name="contract_id" value="">
                    
                    <div class="modal-header">
                        <h5 class="modal-title" id="cancelContractModalLabel">
                            <i class="ti ti-alert-triangle me-2 text-warning"></i>Cancel Mining Contract
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <h6 class="alert-heading">⚠️ Important Notice</h6>
                            <p class="mb-0">Cancelling your mining contract may result in:</p>
                            <ul class="mb-0">
                                <li>Loss of any prepaid mining time</li>
                                <li>Potential cancellation fees</li>
                                <li>Immediate termination of mining rewards</li>
                            </ul>
                        </div>
                        
                        <p>Are you sure you want to cancel the mining contract:</p>
                        <div class="card border">
                            <div class="card-body">
                                <h6 id="cancel-contract-name" class="mb-1">Contract Name</h6>
                                <small class="text-muted" id="cancel-contract-details">Asset details</small>
                            </div>
                        </div>
                        
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" id="cancelContractConfirm" name="confirm_cancel" required>
                            <label class="form-check-label" for="cancelContractConfirm">
                                I understand the consequences and wish to cancel this mining contract.
                            </label>
                            <div class="invalid-feedback">
                                You must confirm to proceed with cancellation.
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            <i class="ti ti-x me-1"></i>Keep Contract
                        </button>
                        <button type="submit" id="cancelContractSubmitBtn" class="btn btn-danger" disabled>
                            <i class="ti ti-trash me-1"></i>Cancel Contract
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</div>
{% endblock %}


{% block extra_js %}
<script src="{{ url_for('static', filename='js/ui-modals.js') }}"></script>
<script src="{{ url_for('static', filename='js/cards-advance.js') }}"></script>
<script>
// Replace your complex mining JavaScript with this simplified version
// that follows the exact same pattern as your working staking modal
// Replace your complex mining JavaScript with this simplified version
// that follows the exact same pattern as your working staking modal
document.addEventListener('DOMContentLoaded', function() {
    let currentMiningData = {};
    const proceedBtn = document.getElementById('proceedToConfirm');
    const packageSelectionInputs = document.querySelectorAll('input[name="package_selection"]');
    const customHashrateInput = document.getElementById('custom_hashrate');
    const customHashrateUnitSelect = document.getElementById('custom_hashrate_unit');
    const durationSelect = document.getElementById('duration');
    const contractNameInput = document.getElementById('contract_name');
    const customHashrateFields = document.getElementById('customHashrateFields');

    // Form elements for modal 2 (hidden inputs)
    const formPoolId = document.getElementById('form-pool-id');
    const formPackageSelection = document.getElementById('form-package-selection');
    const formPackageId = document.getElementById('form-package-id');
    const formCustomHashrate = document.getElementById('form-custom-hashrate');
    const formCustomHashrateUnit = document.getElementById('form-custom-hashrate-unit');
    const formDuration = document.getElementById('form-duration');
    const formContractName = document.getElementById('form-contract-name');

    // Store hashrate packages data
    let hashratePackages = [];

    // Mining button click - populate modal 1 (SIMPLE like staking)
    document.querySelectorAll('.mining-btn').forEach(button => {
        button.addEventListener('click', async function() {
            currentMiningData = {
                poolId: this.getAttribute('data-pool-id'),
                assetSymbol: this.getAttribute('data-asset-symbol'),
                assetName: this.getAttribute('data-asset-name'),
                assetImage: this.getAttribute('data-asset-image'),
                algorithm: this.getAttribute('data-algorithm'),
                poolFee: this.getAttribute('data-pool-fee'),
                minHashrate: this.getAttribute('data-min-hashrate'),
                hashrateUnit: this.getAttribute('data-hashrate-unit'),
                earningsPerUnit: this.getAttribute('data-earnings-per-unit'),
                difficulty: this.getAttribute('data-difficulty')
            };

            // Update modal 1 display
            updateModalDisplay();

            // Fetch hashrate packages for this pool
            await fetchHashratePackages(currentMiningData.poolId);

            // Reset form
            resetForm();
        });
    });

    // Fetch hashrate packages for a pool
    async function fetchHashratePackages(poolId) {
        try {
            console.log(`Fetching packages for pool ID: ${poolId}`);

            const response = await fetch(`/staking/api/mining/packages/${poolId}`);
            if (!response.ok) {
                throw new Error(`Failed to fetch packages: ${response.status}`);
            }

            const data = await response.json();
            console.log(`API response:`, data);

            if (data.success && data.packages && data.packages.length > 0) {
                hashratePackages = data.packages;
                console.log(`${hashratePackages.length} packages loaded successfully`);
                updatePackageOptions();
            } else {
                console.log('No packages in response, using defaults');
                createDefaultPackages();
                updatePackageOptions();
            }
        } catch (error) {
            console.error(`Error fetching packages: ${error.message}`);
            createDefaultPackages();
            updatePackageOptions();
        }
    }

    // Create default packages if API fails
    function createDefaultPackages() {
        const baseHashrate = parseFloat(currentMiningData.minHashrate);
        hashratePackages = [{
                id: 'basic',
                name: 'Basic',
                type: 'basic',
                hashrate: baseHashrate,
                hashrateUnit: currentMiningData.hashrateUnit,
                monthlyCost: baseHashrate * 50,
                powerConsumption: baseHashrate * 10
            },
            {
                id: 'pro',
                name: 'Pro',
                type: 'pro',
                hashrate: baseHashrate * 5,
                hashrateUnit: currentMiningData.hashrateUnit,
                monthlyCost: baseHashrate * 5 * 45, // Slight discount
                powerConsumption: baseHashrate * 5 * 9.5
            },
            {
                id: 'enterprise',
                name: 'Enterprise',
                type: 'enterprise',
                hashrate: baseHashrate * 20,
                hashrateUnit: currentMiningData.hashrateUnit,
                monthlyCost: baseHashrate * 20 * 40, // Better discount
                powerConsumption: baseHashrate * 20 * 9
            }
        ];
    }

    // Update package option displays
    // Update package option displays - simplified for exact name matching
    function updatePackageOptions() {
        const packageTypes = ['basic', 'pro', 'enterprise'];

        console.log('Available packages:', hashratePackages);

        packageTypes.forEach(type => {
            // Find package by exact name match (case insensitive)
            const package = hashratePackages.find(p => p.name.toLowerCase() === type);

            const descEl = document.getElementById(`package_desc_${type}`);
            const priceEl = document.getElementById(`package_price_${type}`);
            const powerEl = document.getElementById(`package_power_${type}`);

            if (package && descEl && priceEl) {
                descEl.innerHTML = `<small>${package.hashrate} ${package.hashrateUnit}</small>`;
                priceEl.textContent = `$${package.monthlyCost.toFixed(2)}/mo`;
                if (powerEl) powerEl.textContent = package.powerConsumption ? `${package.powerConsumption}W` : '';
                console.log(`Updated ${type} package display:`, package);
            } else {
                console.log(`No package found for ${type}, using fallback`);
                // Fallback display
                const baseHashrate = parseFloat(currentMiningData.minHashrate);
                let multiplier = 1;
                let cost = baseHashrate * 50;

                if (type === 'pro') {
                    multiplier = 5;
                    cost = baseHashrate * 5 * 45;
                } else if (type === 'enterprise') {
                    multiplier = 20;
                    cost = baseHashrate * 20 * 40;
                }

                if (descEl) descEl.innerHTML = `<small>${(baseHashrate * multiplier).toFixed(1)} ${currentMiningData.hashrateUnit}</small>`;
                if (priceEl) priceEl.textContent = `$${cost.toFixed(2)}/mo`;
                if (powerEl) powerEl.textContent = `${(baseHashrate * multiplier * 10).toFixed(0)}W`;
            }
        });
    }

    function updateModalDisplay() {
        // Update modal content (same as before)
        document.getElementById('modalAssetName').textContent = currentMiningData.assetName;
        document.getElementById('modalAssetSymbol').textContent = currentMiningData.assetSymbol;
        document.getElementById('modalAlgorithm').textContent = currentMiningData.algorithm;
        document.getElementById('modalPoolFee').textContent = `${currentMiningData.poolFee}% Pool Fee`;
        document.getElementById('modalDifficulty').textContent = currentMiningData.difficulty;
        document.getElementById('modalMinHashrate').textContent = `${currentMiningData.minHashrate} ${currentMiningData.hashrateUnit}`;
        document.getElementById('modalEarningsPerUnit').textContent = `$${currentMiningData.earningsPerUnit} per ${currentMiningData.hashrateUnit}`;

        // Update image
        const modalAssetImage = document.getElementById('modalAssetImage');
        const modalAssetInitial = document.getElementById('modalAssetInitial');
        if (currentMiningData.assetImage) {
            modalAssetImage.src = currentMiningData.assetImage;
            modalAssetImage.style.display = 'block';
            modalAssetInitial.style.display = 'none';
        } else {
            modalAssetImage.style.display = 'none';
            modalAssetInitial.style.display = 'flex';
            modalAssetInitial.textContent = currentMiningData.assetSymbol.charAt(0);
        }
    }

    function resetForm() {
        // Select default package
        document.getElementById('package_selection_pro').checked = true;

        // Set defaults
        customHashrateInput.value = currentMiningData.minHashrate;
        customHashrateUnitSelect.value = currentMiningData.hashrateUnit;
        contractNameInput.value = `${currentMiningData.assetSymbol} Miner #1`;

        // Hide custom fields initially
        customHashrateFields.style.display = 'none';

        updateCalculations();
    }

    // Package selection change
    packageSelectionInputs.forEach(input => {
        input.addEventListener('change', function() {
            const isCustom = this.value === 'custom';
            customHashrateFields.style.display = isCustom ? 'flex' : 'none';
            updateCalculations();
        });
    });

    // Update calculations on input change
    customHashrateInput.addEventListener('input', updateCalculations);
    durationSelect.addEventListener('change', updateCalculations);

    function updateCalculations() {
        // Get current values
        const selectedPackage = Array.from(packageSelectionInputs).find(radio => radio.checked);
        const duration = parseInt(durationSelect.value) || 1;

        let hashrate = parseFloat(currentMiningData.minHashrate);
        let monthlyCost = 0;
        let packageData = null;

        console.log('Selected package:', selectedPackage?.value);
        console.log('Available packages:', hashratePackages);

        if (selectedPackage) {
            if (selectedPackage.value === 'custom') {
                hashrate = parseFloat(customHashrateInput.value) || hashrate;
                monthlyCost = hashrate * 50; // Default pricing for custom
                console.log('Using custom hashrate:', hashrate);
            } else {
                // Find package by exact name match
                packageData = hashratePackages.find(p => p.name.toLowerCase() === selectedPackage.value);

                if (packageData) {
                    hashrate = packageData.hashrate;
                    monthlyCost = packageData.monthlyCost;
                    console.log(`Found API package: ${packageData.name} - ${hashrate} ${packageData.hashrateUnit} - $${monthlyCost}/mo`);
                } else {
                    // Fallback calculation
                    const baseHashrate = parseFloat(currentMiningData.minHashrate);
                    let multiplier = 1;
                    let costMultiplier = 50;

                    if (selectedPackage.value === 'basic') {
                        multiplier = 1;
                        costMultiplier = 50;
                    } else if (selectedPackage.value === 'pro') {
                        multiplier = 5;
                        costMultiplier = 45;
                    } else if (selectedPackage.value === 'enterprise') {
                        multiplier = 20;
                        costMultiplier = 40;
                    }

                    hashrate = baseHashrate * multiplier;
                    monthlyCost = hashrate * costMultiplier;
                    console.log(`Using fallback: ${selectedPackage.value} - ${hashrate} ${currentMiningData.hashrateUnit} - $${monthlyCost}/mo`);
                }
            }
        }

        // Calculate totals
        const totalCost = monthlyCost * duration;
        const monthlyEarnings = hashrate * parseFloat(currentMiningData.earningsPerUnit) * 30;
        const totalEarnings = monthlyEarnings * duration;
        const profit = totalEarnings - totalCost;

        // Update display
        document.getElementById('monthlyCost').textContent = `$${monthlyCost.toFixed(2)}`;
        document.getElementById('monthlyEarnings').textContent = `$${monthlyEarnings.toFixed(2)}`;
        document.getElementById('totalCost').textContent = `$${totalCost.toFixed(2)}`;
        document.getElementById('potentialProfit').textContent = `$${profit.toFixed(2)}`;

        // Enable proceed button if basic validation passes
        const isValid = hashrate > 0 && duration > 0;
        proceedBtn.disabled = !isValid;

        console.log('Calculation results:', {
            hashrate,
            monthlyCost,
            totalCost,
            monthlyEarnings,
            profit
        });

        return {
            hashrate,
            packageData
        };
    }
    // Proceed to confirmation (SIMPLE like staking)
    proceedBtn.addEventListener('click', function() {
        // Get current form values
        const selectedPackage = Array.from(packageSelectionInputs).find(radio => radio.checked);
        const duration = parseInt(durationSelect.value) || 1;
        const contractName = contractNameInput.value || `${currentMiningData.assetSymbol} Miner #1`;

        // Get calculation results
        const calcResults = updateCalculations();
        let hashrate = calcResults.hashrate;
        let hashrateUnit = currentMiningData.hashrateUnit;
        let packageId = '';

        // Set package ID if using a real package from API
        if (selectedPackage.value !== 'custom' && calcResults.packageData && calcResults.packageData.id) {
            packageId = calcResults.packageData.id;
        }

        // SIMPLE TRANSFER - just like staking
        formPoolId.value = currentMiningData.poolId;
        formPackageSelection.value = selectedPackage.value;
        formPackageId.value = packageId; // Use real package ID when available
        formDuration.value = duration;
        formContractName.value = contractName;

        // FIXED: Only set custom fields when actually using custom package
        if (selectedPackage.value === 'custom') {
            hashrate = parseFloat(customHashrateInput.value);
            hashrateUnit = customHashrateUnitSelect.value;
            formCustomHashrate.value = hashrate;
            formCustomHashrateUnit.value = hashrateUnit;
        } else {
            // Clear custom fields for predefined packages
            formCustomHashrate.value = '';
            formCustomHashrateUnit.value = ''; // Don't set any value - let validation skip it
        }

        console.log('Form data set:', {
            poolId: formPoolId.value,
            packageSelection: formPackageSelection.value,
            packageId: formPackageId.value,
            customHashrate: formCustomHashrate.value,
            customHashrateUnit: formCustomHashrateUnit.value,
            duration: formDuration.value,
            contractName: formContractName.value
        });

        // Update confirmation modal display
        updateConfirmationDisplay(hashrate, hashrateUnit, duration, contractName);

        // Reset confirmation modal state
        document.getElementById('agreeTerms').checked = false;
        document.getElementById('confirmMining').disabled = true;
    });

    function updateConfirmationDisplay(hashrate, hashrateUnit, duration, contractName) {
        // Update confirmation modal (simple version)
        document.getElementById('confirm-asset').textContent = currentMiningData.assetSymbol;
        document.getElementById('confirm-algorithm').textContent = currentMiningData.algorithm;
        document.getElementById('confirm-hashrate').textContent = `${hashrate} ${hashrateUnit}`;
        document.getElementById('confirm-duration').textContent = `${duration} Month${duration > 1 ? 's' : ''}`;
        document.getElementById('confirm-fee').textContent = `${currentMiningData.poolFee}%`;

        // Update image in confirmation
        const confirmAssetImage = document.getElementById('confirmAssetImage');
        const confirmAssetInitial = document.getElementById('confirmAssetInitial');
        if (currentMiningData.assetImage) {
            confirmAssetImage.src = currentMiningData.assetImage;
            confirmAssetImage.style.display = 'block';
            confirmAssetInitial.style.display = 'none';
        } else {
            confirmAssetImage.style.display = 'none';
            confirmAssetInitial.style.display = 'flex';
            confirmAssetInitial.textContent = currentMiningData.assetSymbol.charAt(0);
        }
    }

    // Enable confirm button when terms are agreed (same as staking)
    document.getElementById('agreeTerms').addEventListener('change', function() {
        document.getElementById('confirmMining').disabled = !this.checked;
    });

    console.log('Mining modal JavaScript initialized (simplified)');
});
</script>

{% endblock %}